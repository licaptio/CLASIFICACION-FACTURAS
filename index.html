<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ClasificaciÃ³n de Facturas PDD â€“ PROVSOFT</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --azul:#00416A;
  --resalte:#0c6cbd;
  --card:#ffffff;
  --shadow:0 4px 12px rgba(0,0,0,.15);
}
body{
  font-family:'Poppins',sans-serif;
  margin:0;
  background:linear-gradient(to right,var(--azul),#E4E5E6);
}
header{
  background:rgba(255,255,255,.9);
  box-shadow:var(--shadow);
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  position:sticky;
  top:0;
  z-index:10;
}
.filtros{display:flex;gap:10px}
input,select,button{
  padding:6px 10px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:var(--resalte);
  color:white;
  border:none;
}
main{
  display:flex;
  gap:20px;
  padding:20px;
}
.columna{
  flex:1;
  background:rgba(255,255,255,.9);
  border-radius:14px;
  padding:10px;
  min-height:80vh;
  overflow:auto;
}
.tarjeta{
  background:#fff;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
  padding:12px;
  margin-bottom:12px;
  cursor:pointer;
}
.detalle{font-size:13px}
.conceptos{display:none}
.mostrar{display:block}
.selector{display:none;margin-top:8px}
</style>
</head>

<body>

<header>
<h1>ClasificaciÃ³n de Facturas PDD â€“ PROVSOFT</h1>
<div class="filtros">
<select id="selectProveedor">
<option value="">Todos los proveedores</option>
</select>
<input type="date" id="filtroFecha">
<button id="btnBuscar">Buscar</button>
</div>
</header>

<main>
<div class="columna">
<h2>Pendientes de distribuir</h2>
<div id="pendientes"></div>
</div>
<div class="columna">
<h2>Ya distribuidas</h2>
<div id="distribuidas"></div>
</div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ðŸ”¹ Firebase
const firebaseConfig={
  apiKey:"AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain:"inventariopv-643f1.firebaseapp.com",
  projectId:"inventariopv-643f1",
};
const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

const pendientesDiv=document.getElementById("pendientes");
const distribuidasDiv=document.getElementById("distribuidas");

/* ======================================================
   ðŸ”‘ FUNCIÃ“N CLAVE â€” AQUÃ ESTABA EL PROBLEMA REAL
   Lee proveedor desde TODOS los formatos posibles
====================================================== */
function obtenerProveedor(data){
  return (
    data.razon_social_emisor ||
    data.razon_social ||
    data.nombre_proveedor ||
    data.proveedor ||
    data.emisor?.nombre ||
    data.Emisor?.Nombre ||
    data.cfdi?.Emisor?.Nombre ||
    "Sin proveedor"
  );
}

/* ======================================================
   Cargar proveedores al select
====================================================== */
async function cargarProveedores(){
  const snap=await getDocs(collection(db,"almacenes/ALMACENCENTRALPDD/entradas"));
  const set=new Set();

  snap.forEach(d=>{
    const proveedor=obtenerProveedor(d.data());
    if(proveedor!=="Sin proveedor") set.add(proveedor);
  });

  const sel=document.getElementById("selectProveedor");
  sel.innerHTML =
    `<option value="">Todos los proveedores</option>` +
    [...set].sort().map(p=>`<option value="${p}">${p}</option>`).join("");
}

/* ======================================================
   Cargar facturas
====================================================== */
async function cargarFacturas(){
  pendientesDiv.innerHTML="";
  distribuidasDiv.innerHTML="";

  const filtroProv=document.getElementById("selectProveedor").value;
  const filtroFecha=document.getElementById("filtroFecha").value;

  const snap=await getDocs(collection(db,"almacenes/ALMACENCENTRALPDD/entradas"));
  const docs=snap.docs.sort((a,b)=>new Date(b.data().fecha||0)-new Date(a.data().fecha||0));

  for(const docSnap of docs){
    const data=docSnap.data();
    const proveedor=obtenerProveedor(data);

    // Filtros
    if(filtroProv && proveedor!==filtroProv) continue;
    if(filtroFecha && !String(data.fecha||"").includes(filtroFecha)) continue;

    const tipo=(data.tipoFactura||"").toLowerCase();
    const estatus=(data.estatus||"").toLowerCase();
    if(tipo==="pago" || tipo==="transporte" || estatus==="cancelada" || data.uuid_cancelado===true) continue;

    const card=document.createElement("div");
    card.className="tarjeta";
    card.innerHTML=`
      <h3>${proveedor}</h3>
      <div class="detalle">
        <b>Fecha:</b> ${data.fecha||"N/A"}<br>
        <b>Total:</b> $${(data.total||0).toFixed(2)}<br>
        <b>UUID:</b> ${data.uuid_cfdi||docSnap.id}
      </div>
      <div class="conceptos">Cargando...</div>
      <div class="selector">
        <select>
          <option value="">Seleccionar destino...</option>
          <option value="Almacen_Matriz">Almacen_Matriz</option>
          <option value="Gastos">Gastos</option>
        </select>
        <button>Enviar</button>
      </div>
    `;

    card.onclick=()=>{
      card.querySelector(".conceptos").classList.toggle("mostrar");
      card.querySelector(".selector").style.display="flex";
    };

    if(data.distribuido){
      distribuidasDiv.appendChild(card);
    }else{
      pendientesDiv.appendChild(card);
    }
  }
}

// Eventos
document.getElementById("btnBuscar").onclick=cargarFacturas;
document.getElementById("selectProveedor").onchange=e=>{
  localStorage.setItem("filtroProveedorActivo",e.target.value);
  cargarFacturas();
};

// Init
cargarProveedores();
cargarFacturas();
</script>

</body>
</html>
