<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Clasificaci√≥n de Facturas PDD ‚Äì PROVSOFT</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --azul: #00416A;
      --resalte: #0c6cbd;
      --card: #ffffff;
      --shadow: 0 4px 12px rgba(0,0,0,.15);
    }
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(to right, var(--azul), #E4E5E6);
      color: #111;
      min-height: 100vh;
    }
    header {
      background: rgba(255,255,255,0.9);
      box-shadow: var(--shadow);
      padding: 14px 20px;
      display: flex; flex-wrap: wrap;
      justify-content: space-between; align-items: center;
      position: sticky; top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      color: var(--azul);
      font-size: 20px;
      font-weight: 600;
    }
    .filtros {
      display: flex; gap: 10px; align-items: center;
    }
    input, select, button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: inherit;
    }
    button {
      background: var(--resalte);
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #005fa3; }

    main {
      display: flex;
      gap: 20px;
      padding: 20px;
      flex-wrap: wrap;
    }
    .columna {
      flex: 1 1 45%;
      background: rgba(255,255,255,0.9);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 10px;
      min-height: 80vh;
      overflow-y: auto;
    }
    h2 {
      text-align: center;
      color: var(--azul);
      margin-top: 0;
    }
    .tarjeta {
      background: var(--card);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      padding: 12px;
      margin-bottom: 12px;
      transition: 0.2s;
      cursor: pointer;
    }
    .tarjeta:hover { transform: scale(1.01); }
    .tarjeta h3 {
      margin: 0;
      color: var(--azul);
      font-size: 16px;
    }
    .detalle {
      margin-top: 6px;
      font-size: 13px;
    }
    .conceptos {
      font-size: 12px;
      margin-top: 8px;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 6px;
      display: none;
    }
    .mostrar { display: block !important; }
    .selector {
      margin-top: 8px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .selector select {
      flex: 1;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Clasificaci√≥n de Facturas PDD ‚Äì PROVSOFT</h1>
    <div class="filtros">
      <input type="text" id="filtroProveedor" placeholder="Filtrar por proveedor...">
      <input type="date" id="filtroFecha">
      <button id="btnActualizar">Actualizar</button>
    </div>
  </header>

  <main>
    <div class="columna">
      <h2>Pendientes de distribuir</h2>
      <div id="pendientes"></div>
    </div>
    <div class="columna">
      <h2>Ya distribuidas</h2>
      <div id="distribuidas"></div>
    </div>
  </main>

<script type="module">
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, getDocs, doc, setDoc, updateDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// === CONFIGURACI√ìN FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pendientesDiv = document.getElementById("pendientes");
const distribuidasDiv = document.getElementById("distribuidas");
const btnActualizar = document.getElementById("btnActualizar");

const almacenesDestino = [
  "Almacen_Dulces",
  "Almacen_Liquidos",
  "Almacen_Ruta_1",
  "Almacen_Ruta_2",
  "almacen_cigarro",
  "almacen_zapata",
  "almacenabarrotepdd",
  "MERMA"
];

// Limpia la descripci√≥n para que pueda usarse como ID v√°lido
function normalizarId(texto) {
  return texto
    .toLowerCase()
    .replace(/[.#$/[\]\/]/g, "_")
    .replace(/\s+/g, "_")
    .substring(0, 180);
}

// === FUNCIONES PARA V√çNCULOS ===
async function obtenerVinculo(descripcion) {
  const idSeguro = normalizarId(descripcion);
  const ref = doc(db, "vinculos_factura_productos", idSeguro);
  const snap = await getDoc(ref);
  return snap.exists() ? snap.data() : null;
}

async function guardarVinculo(descripcion, productoId, conceptoProd, cantidadOriginal = 1, conversion = 1, cantidadTotal = 1) {
  const idSeguro = normalizarId(descripcion);
  const ref = doc(db, "vinculos_factura_productos", idSeguro);

  // Guardar v√≠nculo normal
  await setDoc(ref, {
    descripcionFactura: descripcion,
    productoId,
    concepto: conceptoProd,
    cantidadOriginal,
    conversion,
    cantidadTotal,
    fechaVinculo: new Date().toISOString()
  });

  // üîπ Actualizar el cat√°logo de productos con la conversi√≥n
  if (conversion && conversion > 1) {
    const refProd = doc(db, "productos", productoId);
    await updateDoc(refProd, {
      conversion_caja_piezas: conversion
    });
  }
}

// === ELIMINAR V√çNCULO EXISTENTE ===
import { deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

async function eliminarVinculo(descripcion) {
  const idSeguro = normalizarId(descripcion);
  const ref = doc(db, "vinculos_factura_productos", idSeguro);
  await deleteDoc(ref);
  alert("‚ùå V√≠nculo eliminado correctamente");
  cargarFacturas(); // refresca autom√°ticamente la vista
}

// === CARGA PRINCIPAL ===
async function cargarFacturas() {
  pendientesDiv.innerHTML = "Cargando...";
  distribuidasDiv.innerHTML = "";

  const filtroProv = document.getElementById("filtroProveedor").value.toLowerCase();
  const filtroFecha = document.getElementById("filtroFecha").value;

  const ref = collection(db, "almacenes/ALMACENCENTRALPDD/entradas");
  const snap = await getDocs(ref);
  pendientesDiv.innerHTML = "";
  distribuidasDiv.innerHTML = "";

  for (const docSnap of snap.docs) {
    const data = docSnap.data();
    const coincideProv = !filtroProv || (data.razon_social_emisor || "").toLowerCase().includes(filtroProv);
    const coincideFecha = !filtroFecha || (data.fecha || "").startsWith(filtroFecha);
    if (!coincideProv || !coincideFecha) continue;

    const card = document.createElement("div");
    card.className = "tarjeta";
    card.innerHTML = `
  <h3>${data.razon_social_emisor || "Sin proveedor"}</h3>
  <div class="detalle">
    <b>Fecha:</b> ${data.fecha || "N/A"}<br>
    <b>Total:</b> $${(data.total ? data.total.toFixed(2) : "0.00")}<br>
    <b>UUID:</b> ${data.uuid_cfdi || docSnap.id}
  </div>
  <div class="conceptos">Cargando conceptos...</div>
  <div class="selector" style="display:none;">
    <select>
      <option value="">Seleccionar destino...</option>
      ${almacenesDestino.map(a => `<option value="${a}">${a}</option>`).join("")}
    </select>
    <button>Enviar</button>
  </div>
`;


// === ABRIR TARJETA ===
card.addEventListener("click", async () => {
  const conceptosDiv = card.querySelector(".conceptos");
  const selectorDiv = card.querySelector(".selector");
  conceptosDiv.classList.toggle("mostrar");
  selectorDiv.style.display = selectorDiv.style.display === "none" ? "flex" : "none";

  if (conceptosDiv.innerHTML === "Cargando conceptos...") {
    const conceptos = data.conceptos_detalle || [];
    let html = "";

    for (const c of conceptos) {
      const vinculo = await obtenerVinculo(c.descripcion);
      if (vinculo) {
        html += `<div>‚úÖ ${c.cantidad} √ó ${c.descripcion} ‚Äî vinculado a <b>${vinculo.concepto}</b>
          <button class="btnReVincular" data-descripcion="${c.descripcion}">üîÅ Cambiar</button>
          <button class="btnEliminarVinculo" data-descripcion="${c.descripcion}">üóë</button>
        </div>`;
      } else {
        html += `<div>${c.cantidad} √ó ${c.descripcion}
          <button class="btnVincular" data-descripcion="${c.descripcion}">Vincular producto</button>
        </div>`;
      }
    }

    conceptosDiv.innerHTML = html;
  }

  // === Vincular producto ===
  let productosActivosCache = null;

  conceptosDiv.querySelectorAll(".btnVincular").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const descripcion = e.target.dataset.descripcion;

      if (!productosActivosCache) {
        const refProd = collection(db, "productos");
        const snapProd = await getDocs(refProd);
        productosActivosCache = snapProd.docs
          .map(d => ({ id: d.id, ...d.data() }))
          .filter(p => p.activo === true);
      }

      // === MODAL ===
      const modal = document.createElement("div");
      modal.style = `
        position:fixed;inset:0;background:rgba(0,0,0,0.5);
        display:flex;align-items:center;justify-content:center;z-index:2000;
      `;
modal.innerHTML = `
  <div style="background:white;padding:20px;border-radius:10px;width:90%;max-width:480px;">
    <h3 style="margin-top:0;color:#00416A;">Buscar producto activo</h3>
    <input id="inputBusquedaProd" type="text" placeholder="Escribe parte del nombre..."
           style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;">
    <div id="resultadosProd" style="max-height:300px;overflow:auto;margin-top:10px;
         border:1px solid #ddd;border-radius:6px;"></div>

    <!-- üîπ Campo agregado -->
    <div id="conversionBox" style="display:none;margin-top:10px;">
      <label style="font-size:13px;color:#333;">Conversi√≥n (piezas por caja):</label>
      <input id="inputConversion" type="number" min="1" placeholder="Ejemplo: 12"
             style="width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;margin-top:4px;">
    </div>

    <button id="cerrarModal" style="margin-top:10px;background:#00416A;color:#fff;border:none;
            padding:6px 10px;border-radius:6px;">Cerrar</button>
  </div>
`;

      document.body.appendChild(modal);
      const inputBusqueda = modal.querySelector("#inputBusquedaProd");
      const listaResultados = modal.querySelector("#resultadosProd");
      modal.querySelector("#cerrarModal").onclick = () => modal.remove();

      // === Filtrado local ===
      inputBusqueda.addEventListener("input", () => {
        const valor = inputBusqueda.value.trim().toLowerCase();
        listaResultados.innerHTML = "";
        if (!valor) return;

        const filtrados = productosActivosCache.filter(p =>
          (p.concepto || "").toLowerCase().includes(valor)
        );

        if (!filtrados.length) {
          listaResultados.innerHTML = "<p style='padding:8px;'>Sin coincidencias</p>";
          return;
        }

        listaResultados.innerHTML = filtrados
          .slice(0, 20)
          .map(p => `
            <div data-id="${p.id}" data-nombre="${p.concepto}"
                 style="padding:6px 8px;cursor:pointer;border-bottom:1px solid #eee;">
              ${p.concepto}
            </div>
          `)
          .join("");

listaResultados.querySelectorAll("div[data-id]").forEach(div => {
  div.addEventListener("click", async () => {
    const productoId = div.dataset.id;
    const nombreProd = div.dataset.nombre;

    // üîπ Mostrar campo de conversi√≥n
    const conversionBox = modal.querySelector("#conversionBox");
    conversionBox.style.display = "block";

    // üîπ Verifica si el producto ya tiene conversi√≥n registrada
    const refProd = doc(db, "productos", productoId);
    const snapProd = await getDoc(refProd);
    if (snapProd.exists() && snapProd.data().conversion_caja_piezas) {
      modal.querySelector("#inputConversion").value = snapProd.data().conversion_caja_piezas;
    }

    // üîπ Esperar confirmaci√≥n del usuario
    const piezasPorCaja = await new Promise(resolve => {
      const input = modal.querySelector("#inputConversion");
      input.focus();

      const btnConfirm = document.createElement("button");
      btnConfirm.textContent = "Vincular con conversi√≥n";
      btnConfirm.style = "margin-top:10px;background:#0c6cbd;color:white;border:none;padding:6px 10px;border-radius:6px;width:100%;";
      conversionBox.appendChild(btnConfirm);

      btnConfirm.onclick = () => {
        const valor = parseInt(input.value) || 1;
        btnConfirm.remove();
        resolve(valor);
      };
    });

    const cantidadOriginal = parseFloat(descripcion.match(/^\d+(\.\d+)?/)) || 1;
    const cantidadTotal = cantidadOriginal * piezasPorCaja;

    await guardarVinculo(descripcion, productoId, nombreProd, cantidadOriginal, piezasPorCaja, cantidadTotal);

    alert(`‚úÖ Vinculado con ${nombreProd} (${cantidadOriginal} √ó ${piezasPorCaja} = ${cantidadTotal} piezas)`);
    modal.remove();
  });
});


// üîπ Actualiza solo el concepto actual sin recargar todo
const item = Array.from(conceptosDiv.children).find(div =>
  div.textContent.includes(descripcion)
);
if (item) {
  item.innerHTML = `‚úÖ ${c.cantidad} √ó ${descripcion} ‚Äî vinculado a <b>${nombreProd}</b>
    <button class="btnReVincular" data-descripcion="${descripcion}">üîÅ Cambiar</button>
    <button class="btnEliminarVinculo" data-descripcion="${descripcion}">üóë</button>`;
}

// üîπ Reasigna eventos locales sin recargar todo
item.querySelector(".btnReVincular").addEventListener("click", async (e) => {
  e.stopPropagation();
  const fakeButton = document.createElement("button");
  fakeButton.dataset.descripcion = descripcion;
  fakeButton.classList.add("btnVincular");
  fakeButton.click();
});

item.querySelector(".btnEliminarVinculo").addEventListener("click", async (e) => {
  e.stopPropagation();
  await eliminarVinculo(descripcion);
});

        });
      });
    });
  });

  // === Re-vincular ===
  conceptosDiv.querySelectorAll(".btnReVincular").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const descripcion = e.target.dataset.descripcion;
      const fakeButton = document.createElement("button");
      fakeButton.dataset.descripcion = descripcion;
      fakeButton.classList.add("btnVincular");
      fakeButton.click();
    });
  });

  // === Eliminar v√≠nculo ===
  conceptosDiv.querySelectorAll(".btnEliminarVinculo").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.stopPropagation();
      const descripcion = e.target.dataset.descripcion;
      await eliminarVinculo(descripcion);
    });
  });
}); // ‚úÖ cierre correcto del card.addEventListener

// === ENV√çO DE FACTURA ===
const boton = card.querySelector("button");
boton.addEventListener("click", async (e) => {
  e.stopPropagation();
  const select = card.querySelector("select");
  const destino = select.value;
  if (!destino) {
    alert("Selecciona un destino.");
    return;
  }

  const refDestino = doc(db, "almacenes/" + destino + "/entradas/" + docSnap.id);
  await setDoc(refDestino, {
    ...data,
    origen: "ALMACENCENTRALPDD",
    fechaDistribucion: new Date().toISOString()
  });

  const refCentral = doc(db, "almacenes/ALMACENCENTRALPDD/entradas/" + docSnap.id);
  await updateDoc(refCentral, {
    destino: destino,
    distribuido: true,
    fechaDistribucion: new Date().toISOString()
  });

  alert("‚úÖ Factura enviada correctamente a " + destino);
  cargarFacturas();
});

// === Clasificaci√≥n visual ===
    if (data.distribuido) {
      distribuidasDiv.appendChild(card);
    } else {
      pendientesDiv.appendChild(card);
    }
  } // üîπ CIERRA el for-loop
} // üîπ CIERRA la funci√≥n cargarFacturas() - ESTA ES LA L√çNEA QUE DEB√çA MOVERSE

// Estas l√≠neas deben estar FUERA de la funci√≥n
btnActualizar.addEventListener("click", cargarFacturas);
cargarFacturas();
  
</script>
</body>
</html>
